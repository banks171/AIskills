---
name: doc-plan-writer
description: |
  This skill should be used when creating reorganization plans, refactoring plans, or any
  design documents that follow the "Plan → Design Doc → Code" workflow. It enforces the
  Principle+Template Dual Confirmation mechanism with HTML comment markup (<!-- CONFIRMED -->):
  any modification to principles or addition of templates requires explicit user confirmation
  with necessity analysis and alternatives.
  Triggers: "create plan", "reorganize", "refactor plan", "design document", "restructure",
  "document architecture", "方案", "重组计划", "设计文档", "原则确认", "模板确认",
  "重构方案", "架构方案", "CONFIRMED标注", "双确认", "写方案", "创建计划",
  "文档重组", "模块重构", "技术方案", "实施计划", "变更方案".
---

# Document Plan Writer

> 方案书写规范：原则+模板双确认机制

## 核心理念

将"方案→设计文档→代码"流程标准化，确保：
- 方案结构完整、逻辑自洽
- 原则和模板的变更受控
- 从方案到执行的可追溯性

---

## 1. 原则+模板双确认机制

### 1.1 何时触发确认

| 触发场景 | 确认要求 | 说明 |
|---------|---------|------|
| **新增原则** | 必须确认 | 任何新的设计原则都需用户认可 |
| **修改原则** | 必须确认 | 修改已确认的原则需重新讨论 |
| **新增模板** | 必须确认 | 新建文档模板需用户认可 |
| **修改模板** | 必须确认 | 调整模板结构需重新确认 |
| **删除原则/模板** | 必须确认 | 移除需说明影响范围 |

### 1.2 确认格式

触发确认时，必须提供以下信息：

```markdown
## 🔔 [原则/模板]确认请求

### 变更内容
{描述要新增/修改/删除的内容}

### 必要性分析
- **问题**：{当前存在什么问题}
- **目标**：{变更后要达成什么目标}
- **影响范围**：{会影响哪些文档/代码}

### 备选方案
| 方案 | 优点 | 缺点 | 推荐度 |
|------|------|------|--------|
| 方案A（推荐） | ... | ... | ⭐⭐⭐ |
| 方案B | ... | ... | ⭐⭐ |
| 方案C（不变更） | ... | ... | ⭐ |

### 请确认
- [ ] 同意变更
- [ ] 选择备选方案：____
- [ ] 需要更多信息
```

**实际对话示例**：

> **场景**：Feed模块重组时发现需要新增"内容亲和"原则

```
🤖 Claude:
## 🔔 原则确认请求

### 变更内容
新增 L2 级原则：**内容亲和原则**（子随父走、逻辑归属、引用即关联）

### 必要性分析
- **问题**：当前 L4 文档按技术类型分组（processing/、tools/），导致父子文档分离
- **目标**：L4 详设文档跟随其 L3 父文档，保持内容聚合
- **影响范围**：docs/Feed/ 目录结构，约 12 个文档需移动

### 备选方案
| 方案 | 优点 | 缺点 | 推荐度 |
|------|------|------|--------|
| 内容亲和原则（推荐） | 父子关系清晰，维护简单 | 需重组现有目录 | ⭐⭐⭐ |
| 保持技术分类 | 无需改动 | 父子文档分散 | ⭐ |

### 请确认
- [ ] 同意变更
- [ ] 选择备选方案：____
- [ ] 需要更多信息

👤 用户: 同意，使用内容亲和原则

🤖 Claude: 已确认。将在方案文档中添加 CONFIRMED 标注：
<!-- CONFIRMED: 2026-02-02 内容亲和三原则 -->
```

### 1.3 HTML确认标注机制

使用 HTML 注释在文档中标注已确认的内容，实现**机器可读+人类可读**的双重追溯：

**标注语法**：
```markdown
<!-- CONFIRMED: YYYY-MM-DD 确认要点简述 -->
```

**标注位置**（章节级标注，非逐行标注）：
```markdown
## 2. 设计原则

<!-- CONFIRMED: 2026-02-01 内容亲和三原则 -->
| 原则 | 定义 | 实践 |
|------|------|------|
| **子随父走** | L4跟随L3父文档 | 子文档放在父文档同名目录下 |
| **逻辑归属** | 按业务逻辑分组 | 避免processing/tools等人为分类 |
```

**查找已确认内容**：
```bash
grep -r "CONFIRMED" docs/
```

**保护规则**：
- ⚠️ 修改 `CONFIRMED` 标注的内容前，必须重新触发确认流程
- ⚠️ 新设计与已确认内容冲突时，优先讨论再执行
- ✅ 无 `CONFIRMED` 标注的内容可自由修改

---

## 2. 方案文档标准结构

基于 `temp/` 方案文档的最佳实践，标准方案文档应包含以下章节：

### 2.1 必需章节

```markdown
# {任务名称}方案

> 一句话描述方案目标

| 元信息 | 值 |
|--------|-----|
| **文档类型** | Plan |
| **状态** | 📝待审批 / ✅已批准 / 🔧执行中 / ✅已完成 |
| **版本** | v{X.Y} |
| **创建日期** | YYYY-MM-DD |

---

## 目录
{自动生成或手动维护}

---

## 1. 核心发现
### 1.1 问题分析
{当前存在的问题，用表格或列表}
### 1.2 目标定义
{重组/重构后要达成的目标}

---

## 2. 设计原则
{指导方案设计的原则，需用户确认}
<!-- CONFIRMED: 日期 要点 -->

---

## 3. 深度分析
{对现状的详细分析，如内容亲和分析、依赖分析等}

---

## 4. 方案设计
### 4.1 目标结构
{目标状态的完整描述}
### 4.2 对比分析
{新旧方案对比}
### 4.3 设计优势
{为什么选择这个方案}

---

## 5. 执行步骤
### Phase 1: {阶段名}
{具体步骤表格}
### Phase 2: {阶段名}
...

---

## 6. 变更清单
{详细的文件/代码变更列表}

---

## 7. 验证清单
- [ ] {验证项1}
- [ ] {验证项2}

---

**计划作者**: {作者}
**审批状态**: 待用户确认
```

### 2.2 章节说明

| 章节 | 必需 | 说明 |
|------|:----:|------|
| 元信息表 | ✅ | 文档类型、状态、版本、日期 |
| 核心发现 | ✅ | 问题分析 + 目标定义 |
| 设计原则 | ✅ | 需双确认的原则 |
| 深度分析 | ⚠️ | 复杂任务需要，简单任务可省略 |
| 方案设计 | ✅ | 目标结构 + 对比分析 |
| 执行步骤 | ✅ | 分阶段的操作清单 |
| 变更清单 | ✅ | 详细的文件变更 |
| 验证清单 | ✅ | 完成后的检查项 |

---

## 3. 方案→设计文档→代码 工作流

### 3.1 三阶段流程

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   Phase 1       │     │   Phase 2       │     │   Phase 3       │
│   方案书写      │ ──▶ │   设计文档      │ ──▶ │   代码实现      │
│   (temp/)       │     │   (docs/)       │     │   (src/)        │
└─────────────────┘     └─────────────────┘     └─────────────────┘
       │                        │                        │
       ▼                        ▼                        ▼
   原则确认              模板确认                 代码评审
   方案审批              文档评审                 测试验证
```

### 3.2 各阶段产物

| 阶段 | 产物位置 | 产物类型 | 交付标准 |
|------|---------|---------|---------|
| **方案** | `temp/{name}_plan.md` | Plan | 用户审批通过 |
| **设计** | `docs/{module}/*.md` | L2/L3/L4 文档 | 符合模板规范 |
| **代码** | `src/` 或项目目录 | 代码文件 | 测试通过 |

### 3.3 阶段转换规则

**方案→设计**：
1. 方案审批状态为"✅已批准"
2. 执行步骤逐一完成
3. 设计文档使用项目定义的模板

**设计→代码**：
1. 设计文档评审通过
2. 接口契约明确
3. 测试用例设计完成

---

## 4. 模板管理

### 4.1 模板清单

To view the current template list, read `references/template_registry.md`.

### 4.2 新增模板流程

1. **识别需求**：发现现有模板无法覆盖的文档类型
2. **触发确认**：使用 §1.2 格式请求用户确认
3. **创建模板**：在 `docs/templates/` 创建新模板
4. **注册模板**：更新模板清单

### 4.3 模板使用检查

创建新文档前，必须：
1. 查找 `docs/templates/` 是否有对应模板
2. 有模板则严格遵循
3. 无模板则触发新增模板确认流程

---

## 5. 实践指南

### 5.1 方案书写流程

```
1. 理解任务
   ↓
2. 深度分析（读取相关文件，理解内容关系）
   ↓
3. 提炼原则（触发原则确认）
   ↓
4. 设计方案（对比备选方案）
   ↓
5. 制定步骤（可执行的操作清单）
   ↓
6. 编写验证（确保可验收）
   ↓
7. 请求审批
```

### 5.2 内容亲和原则

> 来自 Feed 模块重组实践

| 原则 | 定义 | 实践 |
|------|------|------|
| **子随父走** | L4 详设文档跟随其 L3 父文档 | 子文档放在父文档同名目录下 |
| **逻辑归属** | 按业务逻辑而非技术类型分组 | 避免 processing/tools 等人为分类 |
| **引用即关联** | L3 引用的 L4 应在其子目录 | 保持引用路径简洁 |

### 5.3 常见错误

| 错误 | 正确做法 |
|------|---------|
| 未经确认直接修改原则 | 触发双确认流程 |
| 按技术类型分组文档 | 按内容亲和关系分组 |
| 方案缺少验证清单 | 每个方案必须有可执行的验证项 |
| 执行步骤不可操作 | 步骤必须是具体的文件操作 |

---

## 6. 引用资源

- `references/template_registry.md` - 模板注册表引用（指向项目 `docs/templates/README.md`）
- `references/principle_confirmation.md` - 原则确认方法论（原则存储在项目 L1-L4 文档中）
- `assets/plan_template.md` - 方案文档模板

To create a new plan document, copy `assets/plan_template.md` to `temp/` and customize.

---

## 7. 项目集成

### 7.1 原则存储位置

原则**不在 skill 中存储**，而是存储在项目的 L1-L4 文档体系中：

| 层级 | 原则存储位置 | 说明 |
|------|-------------|------|
| L1 | `docs/system_overview.md` | 系统级原则 |
| L2 | `docs/{模块}/README.md` | 模块级原则 |
| L3 | `docs/{模块}/{技术}.md` | 技术级原则 |
| L4 | `docs/{模块}/{子目录}/*.md` | 详设级原则 |

### 7.2 模板存储位置

模板存储在项目的 `docs/templates/` 目录：

- **索引文档**：`docs/templates/README.md`
- **模板选择流程**：按文档类型查找对应模板
- **模板不存在时**：触发【新增模板确认】流程

### 7.3 方案存储位置

方案文档存储在 `temp/` 目录：

- **命名规范**：`{模块}_{任务}_{类型}.md`
  - 类型可选：`plan` | `design` | `refactor` | 自定义
  - 示例：`Feed_reorganization_plan.md`、`computation_unification_plan.md`
- **生命周期**：📝待审批 → ✅已批准 → 🔧执行中 → ✅已完成 → ⚠️已过期
- **归档**：完成后可移至 `docs/plans/` 或标注过期后删除

### 7.4 方案产物

方案执行后根据任务性质产生不同产物：

| 任务性质 | 主要产物 | 说明 |
|---------|---------|------|
| 文档重组 | 目录结构变更 | 文件移动、重命名 |
| 技术设计 | L3/L4 文档 | 新增或更新技术文档 |
| 架构变更 | L2 README 更新 | 模块职责、边界调整 |
| 代码实现 | 代码文件 | 功能开发、重构 |

### 7.5 过期处理

方案内容合并到正式文档后，在元信息表添加过期标注：

```markdown
| **状态** | ⚠️ 已过期 - 内容已合并到 `docs/{模块}/` |
```

过期方案可保留作为历史记录，或在确认无引用后删除。
